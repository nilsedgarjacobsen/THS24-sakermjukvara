# Spring Security - API-fokuserad implementation

## Introduktion

Nu ska vi g√• fr√•n teori till praktik f√∂r API-utveckling! I denna guide kommer vi att:
1. L√§gga till Spring Security till ett REST API-projekt
2. F√∂rst√• vad som h√§nder automatiskt med API-endpoints
3. Skapa v√•r f√∂rsta SecurityConfig-klass f√∂r API:er
4. Konfigurera Security Filter Chain f√∂r REST-endpoints
5. Testa med Postman

## 1. L√§gga till Spring Security

### Maven (pom.xml)
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

### Gradle (build.gradle)
```gradle
implementation 'org.springframework.boot:spring-boot-starter-security'
```

### Vad h√§nder n√§r du startar applikationen?

S√• fort du l√§gger till dependency och startar om din app kommer du se n√•got liknande i konsollen:

```
Using generated security password: a1b2c3d4-e5f6-7890-abcd-ef1234567890

This generated password is for development use only.
```

**Detta betyder:** Spring Security har automatiskt skapat en anv√§ndare √•t dig!
- **Anv√§ndarnamn:** `user`
- **L√∂senord:** `a1b2c3d4-e5f6-7890-abcd-ef1234567890` (√§ndras varje g√•ng du startar om)

## 2. Testa med Postman - Vad h√§nder nu?

### F√∂re Spring Security
```
GET http://localhost:8080/api/products
Response: 200 OK + din produktdata
```

### Efter Spring Security
```
GET http://localhost:8080/api/products
Response: 401 Unauthorized
```

**Detta betyder:** Alla dina API-endpoints kr√§ver nu autentisering!

### Testa autentisering i Postman

1. **G√∂r en GET-request** till `http://localhost:8080/api/products`
2. **G√• till Authorization-fliken** i Postman
3. **V√§lj "Basic Auth"**
4. **Fyll i:**
   - Username: `user`
   - Password: `a1b2c3d4-e5f6-7890-abcd-ef1234567890` (fr√•n konsollen)
5. **Skicka request** - nu b√∂r du f√• 200 OK!

## 3. Vad Spring Security g√∂r automatiskt f√∂r API:er

Bakom kulisserna konfigurerar Spring Security f√∂ljande:
- **Alla endpoints** kr√§ver autentisering (√§ven API-endpoints)
- **HTTP Basic Authentication** fungerar automatiskt
- **CSRF-skydd** √§r aktiverat (kan orsaka problem f√∂r API:er)
- **S√§kra HTTP-headers** skickas automatiskt
- **Sessionhantering** √§r p√•slagen

## 4. Skapa din f√∂rsta API-anpassade SecurityConfig

Nu ska vi ta kontroll √∂ver konfigurationen och anpassa den f√∂r API-utveckling:

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // Konfigurera vilka requests som kr√§ver autentisering
            .authorizeHttpRequests(authz -> authz
                .anyRequest().authenticated()  // Alla requests kr√§ver inloggning
            )
            // Aktivera HTTP Basic Authentication f√∂r API:er
            .httpBasic(Customizer.withDefaults())
            // St√§ng av CSRF-skydd (beh√∂vs inte f√∂r API:er)
            .csrf(csrf -> csrf.disable());
        
        return http.build();
    }
}
```

**Viktiga skillnader fr√•n webb-version:**
- `.httpBasic(Customizer.withDefaults())` ‚Üí Aktiverar Basic Auth som fungerar perfekt med Postman
- `.csrf(csrf -> csrf.disable())` ‚Üí CSRF-skydd beh√∂vs inte f√∂r API:er som testas med Postman
- Ingen `.formLogin()` ‚Üí Vi vill inte ha HTML-formul√§r f√∂r API:er

## 5. Konfigurera API-endpoints steg f√∂r steg

### Steg 1: Till√•t publika API-endpoints

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                // Till√•t alla requests till /api/public/** utan autentisering
                .requestMatchers("/api/public/**").permitAll()
                // Alla andra requests kr√§ver autentisering
                .anyRequest().authenticated()
            )
            .httpBasic(Customizer.withDefaults())
            .csrf(csrf -> csrf.disable());
        
        return http.build();
    }
}
```

**Testa i Postman:**
- `GET /api/public/info` ‚Üí ‚úÖ Ingen autentisering kr√§vs
- `GET /api/products` ‚Üí üîí Kr√§ver Basic Auth (user + l√∂senord fr√•n konsoll)

### Steg 2: Olika regler f√∂r olika API-endpoints

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(authz -> authz
            // Publika endpoints - ingen autentisering kr√§vs
            .requestMatchers("/api/public/**").permitAll()
            .requestMatchers("/api/health/**").permitAll()
            
            // Admin-endpoints - kr√§ver autentisering
            .requestMatchers("/api/admin/**").authenticated()
            
            // Alla andra API-endpoints - kr√§ver autentisering  
            .requestMatchers("/api/**").authenticated()
            
            // Fallback - allt annat kr√§ver ocks√• autentisering
            .anyRequest().authenticated()
        )
        .httpBasic(Customizer.withDefaults())
        .csrf(csrf -> csrf.disable());
    
    return http.build();
}
```

**API-struktur efter denna konfiguration:**
- `/api/public/*` ‚Üí ‚úÖ √ñppet f√∂r alla (ingen Basic Auth)
- `/api/health/*` ‚Üí ‚úÖ Health checks, √∂ppet f√∂r alla
- `/api/admin/*` ‚Üí üîí Kr√§ver Basic Auth
- `/api/*` ‚Üí üîí Alla andra API:er kr√§ver Basic Auth

**Viktigt:** Ordningen spelar roll! Spring Security kollar reglerna uppifr√•n och ner - f√∂rsta matchande regel vinner.

### Steg 3: HTTP-metoder f√∂r REST API:er

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(authz -> authz
            // Publika endpoints
            .requestMatchers("/api/public/**").permitAll()
            
            // L√§soperationer - till√•t utan autentisering
            .requestMatchers(HttpMethod.GET, "/api/products").permitAll()
            .requestMatchers(HttpMethod.GET, "/api/products/**").permitAll()
            
            // Skrivoperationer - kr√§v autentisering
            .requestMatchers(HttpMethod.POST, "/api/products").authenticated()
            .requestMatchers(HttpMethod.PUT, "/api/products/**").authenticated()
            .requestMatchers(HttpMethod.DELETE, "/api/products/**").authenticated()
            
            // Fallback f√∂r allt annat
            .anyRequest().authenticated()
        )
        .httpBasic(Customizer.withDefaults())
        .csrf(csrf -> csrf.disable());
    
    return http.build();
}
```

**REST API-s√§kerhet efter denna konfiguration:**
- `GET /api/products` ‚Üí ‚úÖ Alla kan l√§sa produkter (ingen Basic Auth)
- `GET /api/products/123` ‚Üí ‚úÖ Alla kan l√§sa specifik produkt
- `POST /api/products` ‚Üí üîí Bara autentiserade kan skapa produkter (beh√∂ver Basic Auth)
- `PUT /api/products/123` ‚Üí üîí Bara autentiserade kan uppdatera produkter
- `DELETE /api/products/123` ‚Üí üîí Bara autentiserade kan ta bort produkter

## 6. Komplett API SecurityConfig exempel

```java
@Configuration
@EnableWebSecurity
public class ApiSecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                // Publika endpoints
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/health/**").permitAll()
                
                // L√§sning √∂ppen f√∂r alla
                .requestMatchers(HttpMethod.GET, "/api/products/**").permitAll()
                .requestMatchers(HttpMethod.GET, "/api/categories/**").permitAll()
                
                // Skrivning kr√§ver autentisering
                .requestMatchers(HttpMethod.POST, "/api/**").authenticated()
                .requestMatchers(HttpMethod.PUT, "/api/**").authenticated()
                .requestMatchers(HttpMethod.DELETE, "/api/**").authenticated()
                
                // Admin-endpoints
                .requestMatchers("/api/admin/**").authenticated()
                
                // Allt annat kr√§ver autentisering
                .anyRequest().authenticated()
            )
            .httpBasic()  // Basic Auth f√∂r API:er
            .csrf(csrf -> csrf.disable())  // Ingen CSRF f√∂r API:er
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            );  // Stateless f√∂r API:er
        
        return http.build();
    }
}
```

**Ny addition:** `.sessionManagement()` med `STATELESS` - b√§ttre f√∂r API:er eftersom varje request b√∂r vara oberoende.

## 7. Testa din API-konfiguration med Postman

### Test 1: Publika endpoints (ingen auth)
```
GET http://localhost:8080/api/public/info
Response: 200 OK (utan autentisering)
```

### Test 2: L√§sning utan auth
```
GET http://localhost:8080/api/products
Response: 200 OK (utan autentisering)
```

### Test 3: Skrivning med auth
```
POST http://localhost:8080/api/products
Authorization: Basic Auth (user + l√∂senord fr√•n konsoll)
Body: {"name": "New Product", "price": 299}
Response: 201 Created
```

### Test 4: Skrivning utan auth
```
POST http://localhost:8080/api/products  
Body: {"name": "New Product", "price": 299}
Response: 401 Unauthorized
```

### Test 5: Admin-endpoints
```
GET http://localhost:8080/api/admin/users
Authorization: Basic Auth (user + l√∂senord)
Response: 200 OK
```

## 8. Postman Collection f√∂r testning

Skapa en Postman Collection med dessa requests:

### Collection: "Spring Security API Tests"

1. **GET Public Info** (No Auth)
   - URL: `{{baseUrl}}/api/public/info`
   - Authorization: No Auth

2. **GET Products** (No Auth) 
   - URL: `{{baseUrl}}/api/products`
   - Authorization: No Auth

3. **POST Product** (With Auth)
   - URL: `{{baseUrl}}/api/products`
   - Authorization: Basic Auth (user/password)
   - Body: JSON with product data

4. **PUT Product** (With Auth)
   - URL: `{{baseUrl}}/api/products/1`
   - Authorization: Basic Auth
   - Body: JSON with updated data

5. **DELETE Product** (With Auth)
   - URL: `{{baseUrl}}/api/products/1`
   - Authorization: Basic Auth

**Environment Variables:**
- `baseUrl`: `http://localhost:8080`

## 9. Vanliga API-specifika problem och l√∂sningar

### Problem 1: "403 Forbidden" p√• POST requests
**Orsak:** CSRF-skydd blockerar POST requests  
**L√∂sning:**
```java
.csrf(csrf -> csrf.disable())
```

### Problem 2: "401 Unauthorized" trots korrekt Basic Auth
**Orsak:** L√∂senordet √§ndras vid omstart  
**L√∂sning:** Kopiera det nya l√∂senordet fr√•n konsollen efter varje omstart

### Problem 3: Sessions sparas mellan requests
**Orsak:** Spring Security skapar sessions som standard  
**L√∂sning:**
```java
.sessionManagement(session -> 
    session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
)
```

### Problem 4: OPTIONS requests blockeras (CORS preflight)
**Orsak:** CORS preflight requests beh√∂ver special hantering  
**L√∂sning:**
```java
.requestMatchers(HttpMethod.OPTIONS, "/**").permitAll()
```

## 10. Debugging tips f√∂r API-utveckling

### Aktivera debug-logging
I `application.properties`:
```properties
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web=DEBUG
```

### Testa utan s√§kerhet (endast utveckling)
Skapa en profil f√∂r utveckling:
```java
@Configuration
@Profile("dev-nosecurity")
public class NoSecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .anyRequest().permitAll()
            )
            .csrf(csrf -> csrf.disable());
        
        return http.build();
    }
}
```

Aktivera med: `--spring.profiles.active=dev-nosecurity`

## Sammanfattning

Du har nu l√§rt dig att:
- ‚úÖ Konfigurera Spring Security f√∂r REST API:er
- ‚úÖ Anv√§nda Basic Auth ist√§llet f√∂r form-login
- ‚úÖ St√§nga av CSRF f√∂r API-utveckling
- ‚úÖ Konfigurera olika s√§kerhetsregler f√∂r olika HTTP-metoder
- ‚úÖ Testa med Postman och Basic Auth
- ‚úÖ Skapa stateless API:er med SessionCreationPolicy.STATELESS

## N√§sta steg

I n√§sta guide kommer vi att:
- Skapa egna anv√§ndare ist√§llet f√∂r den genererade
- Integrera med databas f√∂r anv√§ndarhantering
- Implementera JWT-tokens f√∂r API-autentisering
- Skapa rollbaserad auktorisering f√∂r API:er

---

**Kom ih√•g:** Anv√§nd alltid `user` och l√∂senordet fr√•n konsollen f√∂r Basic Auth i Postman!